name: Validate Kustomize Files

on: 
  pull_request:
    branches: [ main ] 

jobs:
  validate-kustomize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
           mv kustomize /usr/local/bin/kustomize
      
      - name: Install kubeconform
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz && tar xf kubeval-linux-amd64.tar.gz && mv kubeval /usr/local/bin

      - name: List Directory and Run Kustomize Build then kubeconform
        run: |
          for dir in $(find ./overlays -maxdepth 1 -type d); do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Processing Kustomize directory: $dir"
              if ! kustomize build ; then
                echo "Kustomize build failed in directory: $dir"
                exit 1
              fi
            fi
          done